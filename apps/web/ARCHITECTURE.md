# 인증 시스템 아키텍처 다이어그램

## 🔄 인증 흐름도

```
┌─────────────────────────────────────────────────────────────────┐
│                         사용자 브라우저                            │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       │ 1. 페이지 요청
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                      middleware.ts                               │
│  • 모든 요청 가로채기                                              │
│  • 쿠키에서 세션 토큰 확인                                          │
│  • Supabase로 사용자 검증                                          │
│  • 라우트 보호 규칙 적용                                            │
└──────────────────────┬──────────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
   ┌────────┐    ┌────────┐    ┌────────┐
   │인증 필요│    │인증됨  │    │공개    │
   │페이지  │    │/auth/* │    │페이지  │
   └───┬────┘    └───┬────┘    └───┬────┘
       │             │             │
       │ 로그인 X    │ 로그인 O    │ 모두 OK
       │             │             │
       ▼             ▼             ▼
  /auth/login   /demo로        렌더링
  리다이렉트    리다이렉트
```

## 🔐 회원가입 플로우

```
사용자                SignupForm              API Route           Supabase
  │                      │                       │                   │
  │ 1. 폼 작성           │                       │                   │
  ├─────────────────────>│                       │                   │
  │                      │ 2. 유효성 검사        │                   │
  │                      │    (비밀번호 6자+)    │                   │
  │                      │                       │                   │
  │                      │ 3. POST /api/auth/signup                  │
  │                      ├──────────────────────>│                   │
  │                      │                       │ 4. signUp()       │
  │                      │                       ├──────────────────>│
  │                      │                       │                   │
  │                      │                       │ 5. 사용자 생성     │
  │                      │                       │    이메일 전송     │
  │                      │                       │<──────────────────┤
  │                      │ 6. 성공 응답          │                   │
  │                      │<──────────────────────┤                   │
  │ 7. 성공 메시지 표시  │                       │                   │
  │<─────────────────────┤                       │                   │
  │                      │                       │                   │
  │ 8. 2초 후 /auth/login으로 리다이렉트          │                   │
  │<─────────────────────┤                       │                   │
```

## 🔑 로그인 플로우

```
사용자                LoginForm               API Route           Supabase
  │                      │                       │                   │
  │ 1. 이메일/비밀번호   │                       │                   │
  ├─────────────────────>│                       │                   │
  │                      │ 2. POST /api/auth/login                   │
  │                      ├──────────────────────>│                   │
  │                      │                       │ 3. signInWithPassword
  │                      │                       ├──────────────────>│
  │                      │                       │                   │
  │                      │                       │ 4. 검증 & JWT 생성│
  │                      │                       │<──────────────────┤
  │                      │ 5. 세션 쿠키 설정     │                   │
  │                      │<──────────────────────┤                   │
  │ 6. AuthContext 업데이트                      │                   │
  │<─────────────────────┤                       │                   │
  │                      │                       │                   │
  │ 7. /demo로 리다이렉트│                       │                   │
  │<─────────────────────┤                       │                   │
```

## 🔄 세션 갱신 플로우

```
브라우저              Middleware              Supabase
  │                      │                       │
  │ 1. 페이지 요청       │                       │
  ├─────────────────────>│                       │
  │                      │ 2. 쿠키에서 토큰 추출 │
  │                      │                       │
  │                      │ 3. getUser()          │
  │                      ├──────────────────────>│
  │                      │                       │
  │                      │ 4. 사용자 정보 & 토큰 검증
  │                      │<──────────────────────┤
  │                      │                       │
  │                      │ 5. 필요시 토큰 갱신   │
  │                      │    (자동)             │
  │                      │                       │
  │ 6. 갱신된 쿠키와 함께 응답                   │
  │<─────────────────────┤                       │
```

## 📱 컴포넌트 계층 구조

```
app/layout.tsx
  └─ AuthProvider (전역 인증 상태)
      │
      ├─ 공개 페이지
      │   └─ app/page.tsx (홈)
      │
      ├─ 인증 페이지
      │   ├─ app/auth/login/page.tsx
      │   │   └─ LoginForm
      │   ├─ app/auth/signup/page.tsx
      │   │   └─ SignupForm
      │   └─ app/auth/reset-password/page.tsx
      │       └─ PasswordResetForm
      │
      └─ 보호된 페이지
          └─ app/demo/page.tsx
              └─ UserMenu
```

## 🗄️ 상태 관리 구조

```
AuthContext (React Context)
  │
  ├─ State
  │   ├─ user: User | null
  │   └─ loading: boolean
  │
  ├─ Methods
  │   ├─ signOut()
  │   └─ refreshUser()
  │
  └─ Effects
      └─ onAuthStateChange (Supabase 리스너)
          ├─ 로그인 이벤트
          ├─ 로그아웃 이벤트
          └─ 토큰 갱신 이벤트
```

## 🛡️ 보안 레이어

```
┌─────────────────────────────────────────────┐
│              브라우저 레이어                  │
│  • AuthContext (클라이언트 상태)             │
│  • useAuth hook (컴포넌트 접근)              │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│            미들웨어 레이어                    │
│  • middleware.ts (모든 요청 검증)            │
│  • 자동 리다이렉트                           │
│  • 세션 갱신                                 │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│            서버 레이어                        │
│  • API Routes (인증 검증)                    │
│  • Server Components (SSR 인증)              │
│  • 쿠키 기반 세션                            │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│            Supabase 레이어                    │
│  • JWT 검증                                  │
│  • 사용자 관리                               │
│  • RLS 정책 (Row Level Security)             │
└─────────────────────────────────────────────┘
```

## 🔄 API 엔드포인트 맵

```
/api/auth/
  ├─ login         POST   로그인
  ├─ signup        POST   회원가입
  ├─ logout        POST   로그아웃
  ├─ reset-password POST   비밀번호 재설정 요청
  ├─ callback      GET    이메일 확인 콜백
  └─ user          GET    현재 사용자 정보
```

## 📄 페이지 라우트 맵

```
/
  ├─ /                      공개 (홈페이지)
  ├─ /auth/
  │   ├─ login              공개 (로그인)
  │   ├─ signup             공개 (회원가입)
  │   ├─ reset-password     공개 (비밀번호 재설정)
  │   ├─ update-password    공개 (비밀번호 업데이트)
  │   └─ auth-code-error    공개 (에러 페이지)
  │
  └─ /demo                  🔒 보호됨 (인증 필요)
```

## 🍪 쿠키 구조

```
쿠키 이름: sb-<project-ref>-auth-token
속성:
  • httpOnly: true        (JavaScript 접근 불가)
  • secure: true          (HTTPS only)
  • sameSite: lax         (CSRF 보호)
  • path: /               (전체 경로)
  • maxAge: 3600          (1시간, 자동 갱신)

내용:
  • access_token: JWT
  • refresh_token: 재발급용 토큰
  • expires_at: 만료 시간
```

## 🔐 보안 체크리스트

```
✅ 비밀번호 최소 6자
✅ HTTPS 사용 (프로덕션)
✅ HttpOnly 쿠키
✅ CSRF 보호 (SameSite)
✅ JWT 자동 갱신
✅ 서버 사이드 검증
✅ 미들웨어 라우트 보호
✅ 클라이언트 상태 동기화
✅ 에러 핸들링
✅ 로딩 상태 관리
```

## 📊 데이터 흐름 요약

```
1. 사용자 액션
   ↓
2. Client Component (useAuth)
   ↓
3. API Route (/api/auth/*)
   ↓
4. Supabase Client (server.ts)
   ↓
5. Supabase 서버
   ↓
6. JWT 생성/검증
   ↓
7. 쿠키 설정
   ↓
8. Middleware 검증
   ↓
9. AuthContext 업데이트
   ↓
10. UI 리렌더링
```

---

이 다이어그램을 참고하여 전체 인증 시스템의 흐름을 이해하실 수 있습니다.
